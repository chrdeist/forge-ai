/**
 * Documentation Agent (Generic, RVD-based)
 * 
 * Purpose:
 * - Generates comprehensive project documentation
 * - Creates API docs, guides, examples, README
 * - Reads from all RVD sections, writes to RVD documentation section
 * 
 * Input: RVD file (all sections populated)
 * Output: RVD file with documentation-section populated
 * 
 * No hardcoded content - fully generic implementation
 */

import fs from 'node:fs';
import path from 'node:path';
import { BaseAgent } from './baseAgent.mjs';
import { RVDManager } from './rvd-manager.mjs';

export class DocumentationAgent extends BaseAgent {
  constructor(config = {}) {
    super(config);
    this.rvdManager = new RVDManager(config);
  }

  /**
   * Main execute method
   * @param {string} rvdFilePath - Path to RVD file (with all sections)
   */
  async execute(rvdFilePath) {
    if (!fs.existsSync(rvdFilePath)) {
      throw new Error(`RVD file not found: ${rvdFilePath}`);
    }

    this._log(`ðŸ“š Generating documentation from RVD`);

    // Load knowledge base for learning
    this.loadKnowledgeBase();

    // Load RVD file
    const rvd = await this.rvdManager.load(rvdFilePath);

    if (!rvd.technical) {
      throw new Error('Technical section not found in RVD file. Run TechnicalRequirementsAgent first.');
    }

    // Set context
    this.setRequirementContext(rvd.project || {});

    // Generate documentation
    const documentationData = this._generateDocumentation(
      rvd,
      rvd.project?.name || 'unknown'
    );

    // Write to documentation section
    rvd.documentation = {
      timestamp: new Date().toISOString(),
      generatedBy: 'DocumentationAgent',
      data: documentationData,
    };

    // Save RVD file
    await this.rvdManager.save(rvdFilePath, rvd);
    this._log(`âœ“ Wrote documentation section to RVD`);

    // Learn patterns
    this._learnFromExecution(documentationData);

    return {
      success: true,
      rvdPath: rvdFilePath,
      documentationData,
    };
  }

  /**
   * Generate comprehensive documentation
   * Creates README, API docs, guides, examples
   */
  _generateDocumentation(rvd, projectName) {
    this._log(`  âœ“ Generating documentation for ${projectName}`);

    const readme = this._generateREADME(rvd);
    const apiDocs = this._generateAPIDocs(rvd.technical?.data);
    const guides = this._generateGuides(rvd);
    const examples = this._generateExamples(rvd.technical?.data);
    const changelog = this._generateChangelog(projectName);

    return {
      projectName,
      version: '1.0',
      timestamp: new Date().toISOString(),
      readme,
      apiDocs,
      guides,
      examples,
      changelog,
    };
  }

  /**
   * Generate comprehensive README
   */
  _generateREADME(rvd) {
    const { technical, project } = rvd;
    const projectName = project?.name || 'API Project';

    return {
      title: `# ${projectName}`,
      sections: [
        {
          heading: '## Overview',
          content: `${projectName} is a RESTful API generated by the Forge AI framework. It provides a comprehensive set of endpoints for managing your application.`,
        },
        {
          heading: '## Features',
          content: this._generateFeaturesList(technical?.data?.apis),
        },
        {
          heading: '## Quick Start',
          content: `
### Installation

\`\`\`bash
npm install
\`\`\`

### Configuration

Create a \`.env\` file based on \`.env.example\`:

\`\`\`bash
cp .env.example .env
\`\`\`

### Running Locally

\`\`\`bash
npm run dev
\`\`\`

The API will be available at \`http://localhost:3000\`

### Using Docker

\`\`\`bash
docker-compose up
\`\`\`
          `,
        },
        {
          heading: '## API Endpoints',
          content: this._generateEndpointsSummary(technical?.data?.apis),
        },
        {
          heading: '## Project Structure',
          content: `
\`\`\`
.
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js           # Main application entry point
â”‚   â”œâ”€â”€ routes/            # API route handlers
â”‚   â”œâ”€â”€ services/          # Business logic layer
â”‚   â”œâ”€â”€ models/            # Data models
â”‚   â”œâ”€â”€ middleware/        # Express middleware
â”‚   â””â”€â”€ config/            # Configuration files
â”œâ”€â”€ tests/                 # Test files
â”œâ”€â”€ Dockerfile             # Docker configuration
â”œâ”€â”€ docker-compose.yml     # Docker Compose configuration
â”œâ”€â”€ package.json           # Project dependencies
â””â”€â”€ .env.example           # Environment configuration template
          `,
        },
        {
          heading: '## Development',
          content: `
### Running Tests

\`\`\`bash
npm test
\`\`\`

### Linting

\`\`\`bash
npm run lint
\`\`\`

### Building

\`\`\`bash
npm run build
\`\`\`
          `,
        },
        {
          heading: '## Documentation',
          content: 'See [API Documentation](./docs/API.md) for detailed endpoint documentation.',
        },
        {
          heading: '## License',
          content: 'MIT',
        },
      ],
    };
  }

  /**
   * Generate API documentation
   */
  _generateAPIDocs(technicalData) {
    const apis = technicalData?.apis || [];

    const endpoints = apis.map(api => ({
      method: api.method,
      path: api.path,
      description: api.description || 'API endpoint',
      parameters: {
        path: this._generatePathParams(api.path),
        query: api.queryParams || [],
        body: api.inputStructure || {},
      },
      responses: {
        success: {
          statusCode: 200,
          description: 'Successful response',
          example: api.outputStructure || {},
        },
        error: {
          statusCode: 400,
          description: 'Bad request or validation error',
          example: { error: 'Validation failed', details: [] },
        },
      },
      examples: this._generateEndpointExamples(api),
    }));

    return {
      version: technicalData?.version || '1.0',
      baseUrl: 'http://localhost:3000/api',
      endpoints,
      dataStructures: technicalData?.dataStructures || [],
      errorTypes: technicalData?.errorHandling || {},
    };
  }

  /**
   * Generate user guides
   */
  _generateGuides(rvd) {
    return [
      {
        title: 'Getting Started',
        filename: 'guides/01-getting-started.md',
        content: `# Getting Started

This guide will help you get the API up and running on your local machine.

## Prerequisites

- Node.js 18.0.0 or higher
- npm or yarn
- Docker (optional, for containerized deployment)

## Installation

1. Clone the repository
2. Install dependencies: \`npm install\`
3. Configure environment: \`cp .env.example .env\`
4. Start the server: \`npm run dev\`

## First Request

Once the server is running, test it with:

\`\`\`bash
curl http://localhost:3000/health
\`\`\`

You should receive:
\`\`\`json
{
  "status": "healthy",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "uptime": 123.45
}
\`\`\`
        `,
      },
      {
        title: 'Authentication',
        filename: 'guides/02-authentication.md',
        content: `# Authentication

This guide covers authentication and authorization.

## Overview

The API uses standard HTTP authentication methods. Include your credentials in the request headers.

## Example

\`\`\`bash
curl -H "Authorization: Bearer YOUR_TOKEN" \\
  http://localhost:3000/api/resource
\`\`\`

## Token-based Authentication

Tokens should be included in the \`Authorization\` header with the \`Bearer\` scheme.

## Rate Limiting

The API implements rate limiting to prevent abuse:
- 100 requests per minute for unauthenticated requests
- 1000 requests per minute for authenticated requests
        `,
      },
      {
        title: 'Error Handling',
        filename: 'guides/03-error-handling.md',
        content: `# Error Handling

This guide explains how the API handles errors.

## Error Response Format

All errors follow a standard format:

\`\`\`json
{
  "error": {
    "message": "Description of the error",
    "statusCode": 400,
    "timestamp": "2024-01-01T00:00:00.000Z"
  }
}
\`\`\`

## Common Error Codes

- \`400\` - Bad Request: Invalid input or missing required fields
- \`401\` - Unauthorized: Authentication required or invalid credentials
- \`403\` - Forbidden: Insufficient permissions
- \`404\` - Not Found: Resource does not exist
- \`500\` - Internal Server Error: Unexpected server error

## Retry Strategy

Implement exponential backoff for 5xx errors:
- First retry: 1 second
- Second retry: 2 seconds
- Third retry: 4 seconds
        `,
      },
      {
        title: 'Deployment',
        filename: 'guides/04-deployment.md',
        content: `# Deployment

This guide covers deploying the API to production.

## Docker Deployment

### Build and Run

\`\`\`bash
docker build -t myapi:1.0 .
docker run -p 3000:3000 myapi:1.0
\`\`\`

### Using Docker Compose

\`\`\`bash
docker-compose up -d
\`\`\`

## Environment Configuration

Set appropriate environment variables for production:

\`\`\`bash
NODE_ENV=production
PORT=3000
DB_HOST=production-db.example.com
DB_USER=prod_user
DB_PASSWORD=secure_password
\`\`\`

## Health Checks

The API includes a health check endpoint for monitoring:

\`\`\`bash
curl http://localhost:3000/health
\`\`\`

## Monitoring

Implement logging and monitoring in production:
- Application logs
- Performance metrics
- Error tracking
- Request monitoring
        `,
      },
    ];
  }

  /**
   * Generate code examples
   */
  _generateExamples(technicalData) {
    const apis = technicalData?.apis || [];

    return {
      curl: this._generateCurlExamples(apis),
      javascript: this._generateJavaScriptExamples(apis),
      python: this._generatePythonExamples(apis),
    };
  }

  /**
   * Generate curl examples
   */
  _generateCurlExamples(apis) {
    return apis.slice(0, 3).map((api, idx) => {
      const method = (api.method || 'POST').toUpperCase();
      const p = api.path || `/${api.name || 'endpoint-' + (idx + 1)}`;
      return {
        method,
        path: p,
        example: `curl -X ${method} http://localhost:3000/api${p} \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(api.inputStructure || {}, null, 2)}'`,
      };
    });
  }

  /**
   * Generate JavaScript examples
   */
  _generateJavaScriptExamples(apis) {
    return apis.slice(0, 3).map((api, idx) => {
      const method = (api.method || 'POST').toUpperCase();
      const p = api.path || `/${api.name || 'endpoint-' + (idx + 1)}`;
      return {
        method,
        path: p,
        example: `const response = await fetch('http://localhost:3000/api${p}', {
  method: '${method}',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(${JSON.stringify(api.inputStructure || {}, null, 4)})
});
const data = await response.json();
console.log(data);`,
      };
    });
  }

  /**
   * Generate Python examples
   */
  _generatePythonExamples(apis) {
    return apis.slice(0, 3).map((api, idx) => {
      const methodLower = (api.method || 'POST').toLowerCase();
      const p = api.path || `/${api.name || 'endpoint-' + (idx + 1)}`;
      return {
        method: methodLower,
        path: p,
        example: `import requests

response = requests.${methodLower}(
  'http://localhost:3000/api${p}',
  json=${JSON.stringify(api.inputStructure || {}, null, 4)}
)
data = response.json()
print(data)`,
      };
    });
  }

  /**
   * Generate changelog
   */
  _generateChangelog(projectName) {
    return {
      filename: 'CHANGELOG.md',
      content: `# Changelog

All notable changes to ${projectName} will be documented in this file.

## [1.0.0] - 2024-01-01

### Added
- Initial release
- Core API endpoints
- Authentication system
- Docker containerization
- Comprehensive documentation
- Unit and integration tests

### Features
- RESTful API design
- Error handling
- Input validation
- Rate limiting
- Health check endpoint
- Docker support

### Documentation
- API documentation
- Getting started guide
- Deployment guide
- Example requests

---

## Release Notes

### Version 1.0.0

Initial release of ${projectName}. This version includes:
- Complete API implementation
- Comprehensive test coverage
- Docker deployment support
- Full documentation
      `,
    };
  }

  /**
   * Helper: Generate features list
   */
  _generateFeaturesList(apis) {
    if (!apis || apis.length === 0) {
      return '- RESTful API design\n- Error handling\n- Input validation\n- Rate limiting';
    }

    const features = [
      `- ${apis.length} API endpoints`,
      '- RESTful design',
      '- Input validation',
      '- Error handling',
      '- Request logging',
      '- Health check endpoint',
      '- Docker support',
    ];

    return features.join('\n');
  }

  /**
   * Helper: Generate endpoints summary
   */
  _generateEndpointsSummary(apis) {
    if (!apis || apis.length === 0) {
      return '| Method | Endpoint | Description |\n|--------|----------|-------------|\n| GET | /api/health | Health check |';
    }

    let summary = '| Method | Endpoint | Description |\n|--------|----------|-------------|\n';
    summary += '| GET | /api/health | Health check |\n';
    
    apis.slice(0, 5).forEach(api => {
      summary += `| ${api.method} | ${api.path} | ${api.description || 'API endpoint'} |\n`;
    });

    if (apis.length > 5) {
      summary += `| ... | ... | ${apis.length - 5} more endpoints |\n`;
    }

    return summary;
  }

  /**
   * Helper: Generate path parameters from URL
   */
  _generatePathParams(path) {
    const params = [];
    const paramRegex = /:([a-zA-Z_][a-zA-Z0-9_]*)/g;
    let match;

    while ((match = paramRegex.exec(path)) !== null) {
      params.push({
        name: match[1],
        required: true,
        type: 'string',
        description: `The ${match[1]} parameter`,
      });
    }

    return params;
  }

  /**
   * Helper: Generate endpoint examples
   */
  _generateEndpointExamples(api) {
    return [
      {
        title: 'Using curl',
        code: `curl -X ${api.method} http://localhost:3000/api${api.path} \\
  -H "Content-Type: application/json"`,
      },
      {
        title: 'Using JavaScript fetch',
        code: `const response = await fetch('http://localhost:3000/api${api.path}', {
  method: '${api.method}',
  headers: { 'Content-Type': 'application/json' }
});
const data = await response.json();`,
      },
    ];
  }

  /**
   * Learn patterns from execution
   */
  _learnFromExecution(docs) {
    const endpointCount = docs?.apiDocs?.endpoints?.length || 0;
    this.learnPattern({
      name: 'documentation-generation',
      category: 'generic-pattern',
      description: `Generated documentation for ${endpointCount} endpoints with guides and examples`,
      successRate: 0.8,
    });
  }
}

export default DocumentationAgent;
